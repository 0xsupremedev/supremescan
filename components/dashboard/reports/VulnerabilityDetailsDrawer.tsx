'use client'

import { motion, AnimatePresence } from 'framer-motion'
import { X, Copy, Download, User, Calendar, Code, AlertTriangle } from 'lucide-react'
import { cn } from '@/lib/utils'
import type { VulnerabilityReport } from '@/lib/types/dashboard'

interface VulnerabilityDetailsDrawerProps {
  report: VulnerabilityReport | null
  onClose: () => void
  onMarkReviewed?: (id: string) => void
  onAssignAnalyst?: (id: string) => void
}

export default function VulnerabilityDetailsDrawer({
  report,
  onClose,
  onMarkReviewed,
  onAssignAnalyst,
}: VulnerabilityDetailsDrawerProps) {
  if (!report) return null

  const copyToClipboard = (text: string) => {
    navigator.clipboard.writeText(text)
  }

  const getSeverityColor = (severity: string) => {
    switch (severity) {
      case 'high':
        return 'text-red-400'
      case 'medium':
        return 'text-orange-400'
      case 'low':
        return 'text-yellow-400'
      default:
        return 'text-gray-400'
    }
  }

  return (
    <AnimatePresence>
      {report && (
        <>
          {/* Backdrop */}
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="fixed inset-0 bg-black/50 z-40 lg:hidden"
          />

          {/* Drawer */}
          <motion.div
            initial={{ x: '100%' }}
            animate={{ x: 0 }}
            exit={{ x: '100%' }}
            transition={{ type: 'spring', damping: 25, stiffness: 200 }}
            className="fixed right-0 top-0 h-full w-full lg:w-1/3 xl:w-1/4 bg-deep-navy border-l border-white/10 z-50 overflow-y-auto"
          >
            <div className="p-6 space-y-6">
              {/* Header */}
              <div className="flex items-start justify-between">
                <div>
                  <h2 className="text-lg font-bold text-white mb-1">
                    Vulnerability Details ({report.id})
                  </h2>
                  <p className="text-sm text-gray-300">{report.title}</p>
                </div>
                <button
                  onClick={onClose}
                  className="p-2 rounded-lg bg-white/5 hover:bg-white/10 transition-colors"
                >
                  <X className="w-4 h-4 text-gray-400" />
                </button>
              </div>

              {/* Description */}
              <div className="glass rounded-lg p-4">
                <div className="flex items-center gap-2 mb-2">
                  <span className="text-xs font-semibold text-gray-300">Description</span>
                  <span className="text-xs text-gray-500">(AI-Generated)</span>
                </div>
                <p className="text-sm text-gray-300 leading-relaxed">{report.description}</p>
              </div>

              {/* Code Snippet */}
              <div className="glass rounded-lg p-4">
                <div className="flex items-center gap-2 mb-3">
                  <Code className="w-4 h-4 text-gray-400" />
                  <span className="text-xs font-semibold text-gray-300">Code Snippet</span>
                  <span className="text-xs text-gray-500">
                    Lines {report.codeStartLine}–{report.codeEndLine}
                  </span>
                </div>
                <div className="relative bg-black/30 rounded-lg p-4 font-mono text-xs overflow-x-auto border border-white/10">
                  <div className="flex items-start gap-2">
                    <div className="text-gray-500 select-none">
                      {Array.from({ length: report.codeEndLine - report.codeStartLine + 1 }).map(
                        (_, i) => (
                          <div key={i} className="h-5">
                            {report.codeStartLine + i}
                          </div>
                        )
                      )}
                    </div>
                    <div className="flex-1 text-gray-300">
                      <pre className="whitespace-pre-wrap">
                        {report.codeSnippet.split('\n').map((line, i) => {
                          const lineNum = report.codeStartLine + i
                          const isRisky = line.includes('call') || line.includes('transfer')
                          return (
                            <div
                              key={i}
                              className={cn(
                                'flex items-center gap-2',
                                isRisky && 'text-red-400 bg-red-500/10 px-2 rounded'
                              )}
                            >
                              {isRisky && <AlertTriangle className="w-3 h-3 text-red-400" />}
                              <span>{line}</span>
                            </div>
                          )
                        })}
                      </pre>
                    </div>
                  </div>
                  {report.compilerVersion && (
                    <div className="mt-3 pt-3 border-t border-white/10 text-[10px] text-gray-500">
                      Compiler: {report.compilerVersion}
                    </div>
                  )}
                </div>
              </div>

              {/* Metadata */}
              <div className="glass rounded-lg p-4">
                <h3 className="text-xs font-semibold text-gray-300 mb-3">Contract Metadata</h3>
                <div className="space-y-2 text-xs">
                  <div className="flex items-center justify-between">
                    <span className="text-gray-400">Contract Address</span>
                    <div className="flex items-center gap-2">
                      <span className="font-mono text-gray-300">{report.contractAddress}</span>
                      <button
                        onClick={() => copyToClipboard(report.contractAddress)}
                        className="p-1 rounded hover:bg-white/5"
                      >
                        <Copy className="w-3 h-3 text-gray-400" />
                      </button>
                    </div>
                  </div>
                  <div className="flex items-center justify-between">
                    <span className="text-gray-400">Chain</span>
                    <span className="text-gray-300">{report.chain}</span>
                  </div>
                  {report.deployer && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-400">Deployer</span>
                      <div className="flex items-center gap-2">
                        <span className="font-mono text-gray-300">
                          {report.deployer.slice(0, 10)}...{report.deployer.slice(-8)}
                        </span>
                        <button
                          onClick={() => copyToClipboard(report.deployer!)}
                          className="p-1 rounded hover:bg-white/5"
                        >
                          <Copy className="w-3 h-3 text-gray-400" />
                        </button>
                      </div>
                    </div>
                  )}
                  {report.compilerVersion && (
                    <div className="flex items-center justify-between">
                      <span className="text-gray-400">Compiler</span>
                      <span className="text-gray-300">{report.compilerVersion}</span>
                    </div>
                  )}
                  <div className="flex items-center justify-between">
                    <span className="text-gray-400">First Seen</span>
                    <span className="text-gray-300">
                      {new Date(report.createdAt).toLocaleDateString()}
                    </span>
                  </div>
                </div>
              </div>

              {/* Remediation */}
              <div className="glass rounded-lg p-4">
                <h3 className="text-xs font-semibold text-gray-300 mb-3">Remediation – AI Scan</h3>
                <ul className="space-y-2">
                  {report.remediation.map((item, index) => (
                    <li key={index} className="flex items-start gap-2 text-sm text-gray-300">
                      <span className="text-purple-400 mt-1">•</span>
                      <span>{item}</span>
                    </li>
                  ))}
                </ul>
              </div>

              {/* Actions */}
              <div className="space-y-2">
                <button
                  onClick={() => onMarkReviewed?.(report.id)}
                  className="w-full px-4 py-2 text-sm font-medium bg-white/5 border border-white/10 rounded-lg text-gray-300 hover:bg-white/10 transition-colors"
                >
                  Mark as Reviewed
                </button>
                <button
                  onClick={() => onAssignAnalyst?.(report.id)}
                  className="w-full px-4 py-2 text-sm font-medium bg-white/5 border border-white/10 rounded-lg text-gray-300 hover:bg-white/10 transition-colors"
                >
                  Assign Analyst
                </button>
                <button className="w-full px-4 py-2 text-sm font-medium bg-gradient-to-r from-purple-600/80 to-blue-600/80 rounded-lg text-white hover:from-purple-600 hover:to-blue-600 transition-all flex items-center justify-center gap-2">
                  <Download className="w-4 h-4" />
                  Download Report
                </button>
              </div>
            </div>
          </motion.div>
        </>
      )}
    </AnimatePresence>
  )
}

